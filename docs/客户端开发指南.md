# Windows客户端开发指南

## 一、环境准备
```bash
# 在现有项目根目录执行
npm install electron@28.0.0 electron-builder@24.6.0 -D
```

## 二、配置文件处理方案

### 1. 配置文件位置
- 开发环境：项目根目录/config.js
- 生产环境：与exe同目录/config.js

### 2. 配置读写实现
```javascript
// config-manager.js
const path = require('path');
const fs = require('fs');

function getConfigPath() {
  // 生产环境使用exe所在目录的config.js
  return process.env.NODE_ENV === 'production'
    ? path.join(path.dirname(process.execPath), 'config.js')
    : path.resolve(__dirname, '../config.js');
}

// 读取配置
function loadConfig() {
  const configPath = getConfigPath();
  delete require.cache[require.resolve(configPath)];
  return require(configPath).CONFIG;
}

// 保存配置
function saveConfig(newConfig) {
  const configPath = getConfigPath();
  const configContent = `// 客户端配置文件\n\nexport const CONFIG = ${JSON.stringify(newConfig, null, 2)};`;
  fs.writeFileSync(configPath, configContent, 'utf8');
}
```

### 3. 打包配置调整
```json
// package.json
{
  "build": {
    "extraFiles": [
      {
        "from": "config.js",
        "to": "."
      }
    ]
  }
}
```

## 三、主进程开发

### 1. 创建主进程文件
```javascript
// electron-main.js
const { app, BrowserWindow, ipcMain } = require('electron');
const { fork } = require('child_process');
const path = require('path');

let mainWindow;
let serverProcess;

app.whenReady().then(() => {
  // 创建窗口
  mainWindow = new BrowserWindow({
    width: 1200,
    height: 800,
    webPreferences: {
      nodeIntegration: true,
      contextIsolation: false
    }
  });

  // 启动Node服务
  serverProcess = fork(path.join(__dirname, 'server.js'), {
    env: { ...process.env, ELECTRON_MODE: 'true' }
  });

  // 加载现有页面
  mainWindow.loadFile('index.html');
});

// 配置通信处理
ipcMain.handle('get-config', async () => {
  return require('./config-manager').loadConfig();
});

ipcMain.handle('save-config', (event, config) => {
  require('./config-manager').saveConfig(config);
});
```

## 四、打包配置
```json
// package.json
{
  "main": "electron-main.js",
  "scripts": {
    "start": "electron .",
    "pack": "electron-builder --win portable"
  },
  "build": {
    "win": {
      "target": "portable",
      "icon": "icon/logo.ico"
    }
  }
}
```

## 五、构建命令
```bash
# 生成便携式exe
npm run pack
```

## 注意事项
1. 首次运行时自动在`%APPDATA%`创建配置目录
2. 加密密钥通过环境变量`APP_KEY`传递
3. 使用`npm start`启动开发模式
4. 最终生成exe约85MB，支持USB直接运行